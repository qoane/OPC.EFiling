<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Review Draft | OPC E‑Filing</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- Diff2Html CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />

    <style>
        body { font-family: Inter, sans-serif; min-height: 100vh; display: flex; flex-direction: column; }
        .navbar { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.06); }
        .main-wrap { flex: 1; padding: 1rem; }
        #diffview { overflow-x: auto; }
        #commentsSidebar { position: fixed; top: 70px; right: 0; bottom: 0; width: 360px; display: none; z-index: 1040; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
                <img src="https://www.gov.ls/wp-content/uploads/2017/08/cropped-cropped-1162px-Coat_of_arms_of_Lesotho.svg_-1.png" width="32" height="32" alt="Lesotho Coat of Arms">
                <span class="fw-bold">OPC <span class="text-primary">E‑Filing</span></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="nav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
                    <li class="nav-item" data-roles="All"><a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link" href="instructions.html"><i class="bi bi-card-list me-1"></i>Instructions</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link active" aria-current="page" href="seniorpc-review.html"><i class="bi bi-clipboard-check me-1"></i>Review</a></li>
                    <li class="nav-item" data-roles="Admin"><a class="nav-link" href="manage-users.html"><i class="bi bi-people me-1"></i>User Management</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-1"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid main-wrap mt-4">
        <h2 class="fw-bold mb-3">Draft Review</h2>
        <div class="row">
            <!-- Left: instructions list -->
            <div class="col-lg-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-inbox me-2"></i>Awaiting Review</span>
                        <button id="btnRefresh" class="btn btn-sm btn-light"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div class="card-body p-0" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                        <div id="instructionsList" class="list-group list-group-flush"></div>
                    </div>
                </div>
            </div>
            <!-- Right: diff viewer and actions -->
            <div class="col-lg-9">
                <div class="card shadow-sm mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <strong id="reviewTitle">Select an instruction</strong>
                            <small id="reviewStatus" class="text-muted ms-2"></small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" id="btnApprove"><i class="bi bi-check-circle me-1"></i>Approve</button>
                            <button class="btn btn-outline-warning" id="btnRequest"><i class="bi bi-pencil-square me-1"></i>Request Revisions</button>
                            <button class="btn btn-outline-primary" id="btnCommentsToggle"><i class="bi bi-chat-square-dots me-1"></i>Comments</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="diffview" class="border"></div>
                    </div>
                    <div id="reviewMessage" class="mx-3 mb-3 small fw-semibold text-danger"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Comments Sidebar -->
    <div id="commentsSidebar"></div>

    <!-- Footer -->
    <footer class="py-4">
        <div class="container text-center small text-muted">© 2025 Government of Lesotho · Office of Parliamentary Counsel</div>
    </footer>

    <!-- JS Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff@5.0.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>

    <script>
        const token = localStorage.getItem('jwtToken');
        if (!token) window.location.href = 'login.html';

        // Navigation role gating
        document.addEventListener('DOMContentLoaded', () => {
            const payload = JSON.parse(atob(token.split('.')[1] || '{}'));
            let roles = [];
            if (payload.role) roles = Array.isArray(payload.role) ? payload.role : [payload.role];
            if (payload.roles) roles = roles.concat(Array.isArray(payload.roles) ? payload.roles : [payload.roles]);
            document.querySelectorAll('[data-roles]').forEach(item => {
                const allowed = item.getAttribute('data-roles').split(',').map(s => s.trim());
                if (!allowed.includes('All') && !allowed.some(r => roles.includes(r))) {
                    item.style.display = 'none';
                }
            });
            document.getElementById('logoutLink').addEventListener('click', e => {
                e.preventDefault();
                if (confirm('Logout?')) {
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                }
            });
        });

        // Elements
        const instructionsListEl = document.getElementById('instructionsList');
        const reviewTitleEl = document.getElementById('reviewTitle');
        const reviewStatusEl = document.getElementById('reviewStatus');
        const diffViewEl = document.getElementById('diffview');
        const reviewMessageEl = document.getElementById('reviewMessage');

        let currentInstructionId = null;

        // Load instructions awaiting review (placeholder: use drafts/all)
        async function loadInstructions() {
            instructionsListEl.innerHTML = '<div class="list-group-item text-muted">Loading…</div>';
            try {
                const res = await fetch('/api/drafts/All', { headers: { Authorization: 'Bearer ' + token } });
                const items = await res.json();
                instructionsListEl.innerHTML = '';
                items.forEach(i => {
                    const btn = document.createElement('button');
                    btn.className = 'list-group-item list-group-item-action';
                    btn.textContent = i.title || ('Instruction #' + i.draftingInstructionID);
                    btn.onclick = () => pickInstruction(i.draftingInstructionID);
                    instructionsListEl.appendChild(btn);
                });
            } catch {
                instructionsListEl.innerHTML = '<div class="list-group-item text-danger">Failed to load</div>';
            }
        }
        loadInstructions();
        document.getElementById('btnRefresh').onclick = loadInstructions;

        async function pickInstruction(id) {
            currentInstructionId = id;
            reviewMessageEl.textContent = '';
            // load brief
            try {
                const res = await fetch('/api/DraftingInstructions/' + id, { headers: { Authorization: 'Bearer ' + token } });
                if (res.ok) {
                    const d = await res.json();
                    reviewTitleEl.textContent = d.title || ('Instruction #' + id);
                    reviewStatusEl.textContent = d.status ? '(' + d.status + ')' : '';
                }
            } catch {}
            // load comparison
            try {
                const res = await fetch('/api/drafts/compare/' + id, { headers: { Authorization: 'Bearer ' + token } });
                if (res.ok) {
                    const comp = await res.json();
                    const oldHtml = comp.oldHtml || '';
                    const newHtml = comp.newHtml || '';
                    // compute diff using diff and diff2html
                    const diffString = Diff.createTwoFilesPatch('Old', 'New', oldHtml, newHtml);
                    const diffHtml = Diff2Html.html(diffString, { drawFileList: false, matching: 'lines', outputFormat: 'side-by-side' });
                    diffViewEl.innerHTML = diffHtml;
                }
            } catch {
                diffViewEl.innerHTML = '<div class="text-danger">Unable to fetch diff</div>';
            }
            // load comments sidebar component
            loadCommentsComponent();
            loadCommentsSidebar(id);
        }

        // Review actions
        document.getElementById('btnApprove').onclick = async () => {
            if (!currentInstructionId) return;
            if (!confirm('Approve this draft?')) return;
            try {
                const res = await fetch('/api/drafts/approve/' + currentInstructionId, { method: 'POST', headers: { Authorization: 'Bearer ' + token } });
                const result = await res.json();
                reviewMessageEl.textContent = result.message || 'Approved.';
            } catch {
                reviewMessageEl.textContent = 'Approval failed';
            }
        };
        document.getElementById('btnRequest').onclick = async () => {
            if (!currentInstructionId) return;
            const feedback = prompt('Enter your revision request comments:');
            if (feedback === null) return;
            try {
                const res = await fetch('/api/drafts/request/' + currentInstructionId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                    body: JSON.stringify({ message: feedback })
                });
                const result = await res.json();
                reviewMessageEl.textContent = result.message || 'Revision requested';
            } catch {
                reviewMessageEl.textContent = 'Request failed';
            }
        };

        // Comments toggle
        document.getElementById('btnCommentsToggle').onclick = () => toggleCommentsSidebar();
        function loadCommentsComponent() {
            if (document.getElementById('commentsSidebar').innerHTML.trim() !== '') return;
            fetch('components/comments-sidebar.html').then(r => r.text()).then(html => {
                document.getElementById('commentsSidebar').innerHTML = html;
            });
        }
        function toggleCommentsSidebar(force) {
            const sidebar = document.getElementById('commentsSidebar');
            const isVisible = sidebar.style.display !== 'none' && sidebar.style.display !== '';
            const show = force !== undefined ? force : !isVisible;
            sidebar.style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>