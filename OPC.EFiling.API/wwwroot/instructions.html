<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>OPC E-Filing — All Instructions</title>

    <!-- 1) BOOTSTRAP 5 CSS (via CDN) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
          rel="stylesheet" />

    <!-- 2) FONT AWESOME (for icons) -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          integrity="sha512-pM2eEdx..."
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />

    <!-- 3) OUR REUSABLE STYLESHEET -->
    <link rel="stylesheet" href="/css/style.css" />

    <style>
        body {
            background: var(--color-bg-light);
            padding-top: calc(var(--header-height) + 10px);
        }

        .table-container {
            max-width: 95%;
            margin: 2rem auto;
            overflow-x: auto;
        }

        table {
            min-width: 800px;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: var(--color-text);
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- ─── NAVBAR (same as other pages) ─────────────────────────────────────────────────────────── -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="https://www.gov.ls/wp-content/uploads/2017/08/cropped-cropped-1162px-Coat_of_arms_of_Lesotho.svg_-1.png"
                     alt="Lesotho Coat of Arms"
                     width="32"
                     height="32"
                     class="me-2" />
                <span class="fw-bold">OPC E-Filing</span>
            </a>
            <button class="navbar-toggler"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarNavInst"
                    aria-controls="navbarNavInst"
                    aria-expanded="false"
                    aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavInst">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="instructions.html">
                            <i class="fas fa-list"></i> All Instructions
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutLinkInst">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- ──────────────────────────────────────────────────────────────────────────────────────── -->
    <!-- ─── MAIN CONTENT: Table of Instructions ─────────────────────────────────────────────────── -->
    <div class="table-container">
        <h2 class="mt-4 mb-3">All Drafting Instructions</h2>
        <div id="feedback" class="mb-3"></div>
        <table class="table table-striped table-bordered align-middle">
            <thead class="table-dark">
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Title</th>
                    <th scope="col">Description</th>
                    <th scope="col">Department ID</th>
                    <th scope="col">Assigned Drafter ID</th>
                    <th scope="col">Status</th>
                    <th scope="col">Priority</th>
                    <th scope="col">Received Date</th>
                    <th scope="col">Attachments</th>
                </tr>
            </thead>
            <tbody id="instructionsBody">
                <!-- Rows will be injected here via JavaScript -->
            </tbody>
        </table>
        <div id="noData" class="no-data d-none">
            No instructions found.
        </div>
    </div>
    <!-- ──────────────────────────────────────────────────────────────────────────────────────── -->
    <!-- ─── LOGOUT CONFIRMATION MODAL ───────────────────────────────────────────────────────────── -->
    <div class="modal fade"
         id="logoutModalInst"
         tabindex="-1"
         aria-labelledby="logoutModalLabelInst"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutModalLabelInst">Confirm Logout</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">Are you sure you want to log out?</div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Cancel
                    </button>
                    <button type="button"
                            class="btn btn-danger"
                            id="confirmLogoutInst">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- ──────────────────────────────────────────────────────────────────────────────────────── -->
    <!-- ─── FOOTER ──────────────────────────────────────────────────────────────────────────────── -->
    <footer class="bg-light text-center py-4 mt-auto">
        <div class="container">
            <p class="mb-1">© 2025 Office of Parliamentary Counsel, Lesotho</p>
            <small>All rights reserved.</small>
        </div>
    </footer>
    <!-- ──────────────────────────────────────────────────────────────────────────────────────── -->
    <!-- ─── BOOTSTRAP 5 JS (via CDN) ────────────────────────────────────────────────────────────── -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // 1) Security check: redirect to login if no JWT found
      const token = localStorage.getItem("jwtToken");
      if (!token) {
        window.location.href = "login.html";
        return;
      }

      // 2) Logout logic (modal)
      const logoutLink = document.getElementById("logoutLinkInst");
      const logoutModal = new bootstrap.Modal(
        document.getElementById("logoutModalInst")
      );
      logoutLink.addEventListener("click", (e) => {
        e.preventDefault();
        logoutModal.show();
      });
      document
        .getElementById("confirmLogoutInst")
        .addEventListener("click", () => {
          localStorage.removeItem("jwtToken");
          window.location.href = "login.html";
        });

      // 3) Fetch instructions from API
      const feedbackDiv = document.getElementById("feedback");
      const tbody = document.getElementById("instructionsBody");
      const noDataDiv = document.getElementById("noData");

      try {
        const response = await fetch("/api/DraftingInstructions", {
          headers: { Authorization: "Bearer " + token }
        });

        if (response.status === 401) {
          // Unauthorized—redirect to login
          window.location.href = "login.html";
          return;
        }
        if (!response.ok) {
          const errorText = await response.text();
          feedbackDiv.innerHTML = `<div class="alert alert-danger">Error loading instructions: ${errorText}</div>`;
          return;
        }

        const instructions = await response.json();

        if (Array.isArray(instructions) && instructions.length > 0) {
          instructions.forEach((inst) => {
            const tr = document.createElement("tr");

            // ID
            const tdId = document.createElement("td");
            tdId.textContent = inst.draftingInstructionID;
            tr.appendChild(tdId);

            // Title
            const tdTitle = document.createElement("td");
            tdTitle.textContent = inst.title || "";
            tr.appendChild(tdTitle);

            // Description
            const tdDesc = document.createElement("td");
            tdDesc.textContent = inst.description || "";
            tr.appendChild(tdDesc);

            // DepartmentID
            const tdDept = document.createElement("td");
            tdDept.textContent = inst.departmentID;
            tr.appendChild(tdDept);

            // Assigned Drafter ID
            const tdDrafter = document.createElement("td");
            tdDrafter.textContent = inst.assignedDrafterID;
            tr.appendChild(tdDrafter);

            // Status
            const tdStatus = document.createElement("td");
            tdStatus.textContent = inst.status || "";
            tr.appendChild(tdStatus);

            // Priority
            const tdPriority = document.createElement("td");
            tdPriority.textContent = inst.priority || "";
            tr.appendChild(tdPriority);

            // ReceivedDate (formatted as YYYY-MM-DD)
            const tdReceived = document.createElement("td");
            const dateObj = new Date(inst.receivedDate);
            tdReceived.textContent = dateObj.toISOString().split("T")[0];
            tr.appendChild(tdReceived);

            // Attachments
            const tdFiles = document.createElement("td");
            if (Array.isArray(inst.files) && inst.files.length > 0) {
              inst.files.forEach((file) => {
                const link = document.createElement("a");
                link.href = `/${file.filePath}`;
                // Because file.filePath is relative to wwwroot (e.g. "uploads/abc.pdf")
                link.textContent = file.fileName;
                link.target = "_blank";
                link.classList.add("d-block", "text-decoration-none");
                tdFiles.appendChild(link);
              });
            } else {
              tdFiles.textContent = "—";
            }
            tr.appendChild(tdFiles);

            tbody.appendChild(tr);
          });
        } else {
          noDataDiv.classList.remove("d-none");
          // Hide table header if desired
          document.querySelector("table").classList.add("d-none");
        }
      } catch (err) {
        feedbackDiv.innerHTML = `<div class="alert alert-danger">Unexpected error loading instructions.</div>`;
        console.error(err);
      }
    });
    </script>
</body>
</html>
