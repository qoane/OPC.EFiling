<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OPC E‑Filing — My Tasks</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- AOS for scroll animations -->
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />

    <style>
        :root {
            --les-blue: #0c4ad4;
            --les-green: #1f8a43;
            --ink-900: #0b1020;
            --ink-700: #1f2a44;
            --ink-500: #4b587a;
            --nude-10: #fdfcfb;
            --nude-25: #fbf8f5;
            --nude-50: #f7f3ef;
            --glass-bg: 24,36,66;
            --glass-alpha: .6;
            --radius-2xl: 22px;
            --shadow-md: 0 10px 30px rgba(11,16,32,.15);
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;
            color: var(--ink-700);
            background: radial-gradient(1200px 800px at 10% -10%, var(--nude-10), var(--nude-25)), radial-gradient(1000px 700px at 110% 10%, var(--nude-50), var(--nude-10));
            overflow-x: hidden;
            padding-top: 72px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Flag bar */
        .flag-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1040;
            box-shadow: 0 2px 10px rgba(0,0,0,.06);
        }
        .flag-bar .bar { height: 6px; }
        .flag-blue { background: var(--les-blue); }
        .flag-white { background: #fff; }
        .flag-green { background: var(--les-green); }

        /* Navbar */
        .navbar.glassy {
            background: rgba(255,255,255,.65) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,.06);
        }

        .brand-mark {
            display: flex;
            align-items: center;
            gap: .6rem;
            font-weight: 800;
            color: var(--ink-900);
        }
        .brand-mark img {
            width: 32px;
            height: 32px;
        }

        /* Hero */
        .page-hero {
            position: relative;
            padding: 64px 0 36px;
        }
        .page-hero .halo {
            position: absolute;
            inset: -80px -40px -40px -40px;
            pointer-events: none;
            z-index: 0;
            background: radial-gradient(900px 500px at 45% -10%, rgba(12,74,212,.18), rgba(12,74,212,0) 60%), radial-gradient(800px 480px at 80% 10%, rgba(31,138,67,.16), rgba(31,138,67,0) 60%);
        }
        .page-hero .inner {
            position: relative;
            z-index: 1;
        }

        .glass {
            background: rgba(var(--glass-bg), var(--glass-alpha));
            backdrop-filter: blur(14px) saturate(130%);
            -webkit-backdrop-filter: blur(14px) saturate(130%);
            border: 1px solid rgba(255,255,255,.25);
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-2xl);
        }

        /* Tasks table */
        .tasks-table th { font-weight: 600; }
        .tasks-table tbody tr:hover { background-color: rgba(0,0,0,.03); }

        /* Small buttons */
        .btn-flag {
            background: linear-gradient(90deg, var(--les-blue), #1a66ff 48%, #fff 49%, #fff 51%, var(--les-green) 52%, #31a95a 100%);
            color: #0b1020;
            border: none;
        }

        .btn-ghost {
            background: #fff;
            border: 1px solid rgba(11,16,32,.12);
        }
    </style>
</head>
<body>
    <!-- Flag bar -->
    <div class="flag-bar">
        <div class="bar flag-blue"></div>
        <div class="bar flag-white"></div>
        <div class="bar flag-green"></div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg glassy fixed-top">
        <div class="container">
            <a class="navbar-brand brand-mark" href="index.html">
                <img src="https://www.gov.ls/wp-content/uploads/2017/08/cropped-cropped-1162px-Coat_of_arms_of_Lesotho.svg_-1.png" alt="Lesotho Coat of Arms" />
                <span>OPC <span class="text-primary">E‑Filing</span></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="nav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
                    <li class="nav-item" data-roles="All"><a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
                    <li class="nav-item" data-roles="All"><a class="nav-link active" aria-current="page" href="tasks.html"><i class="bi bi-list-check me-1"></i>My Tasks</a></li>
                    <li class="nav-item" data-roles="All"><a class="nav-link" href="timeline.html"><i class="bi bi-clock-history me-1"></i>Timeline</a></li>
                    <li class="nav-item" data-roles="SeniorPC,Admin"><a class="nav-link" href="signatures.html"><i class="bi bi-pencil-square me-1"></i>Signatures</a></li>
                    <!-- Notification / Messages / Tasks icons with badges -->
                    <li class="nav-item position-relative" id="navNotifications" data-roles="Drafter,PC,RegistryOfficer,SeniorPC,Admin"><a class="nav-link" href="#"><i class="bi bi-bell"></i><span class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle" style="font-size:.6rem;" id="notifCount">0</span></a></li>
                    <li class="nav-item position-relative" id="navMessages"><a class="nav-link" href="#"><i class="bi bi-envelope"></i><span class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle" style="font-size:.6rem;" id="msgCount">0</span></a></li>
                    <li class="nav-item position-relative" id="navTaskIcon" data-roles="All"><a class="nav-link" href="tasks.html"><i class="bi bi-check-circle"></i><span class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle" style="font-size:.6rem;" id="taskCount">0</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-1"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero section -->
    <section class="page-hero">
        <div class="halo"></div>
        <div class="inner container" data-aos="fade-up">
            <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3">
                <div>
                    <h1 class="display-5 fw-bolder text-dark mb-2">Your Tasks</h1>
                    <p class="mb-0">View and take action on the instructions assigned to you.</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="submit-instruction.html" class="btn btn-flag"><i class="bi bi-plus-circle me-1"></i>New Instruction</a>
                    <a href="dashboard.html" class="btn btn-ghost"><i class="bi bi-arrow-return-left me-1"></i>Back to Dashboard</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Tasks list -->
    <section class="py-4">
        <div class="container" data-aos="fade-up">
            <div class="d-flex align-items-center justify-content-between flex-column flex-md-row gap-3 mb-3">
                <h3 class="fw-bolder mb-0">Assigned Instructions</h3>
                <div class="input-group w-100 w-md-auto" style="max-width:360px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by title or status" aria-label="Search" />
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle tasks-table" id="tasksTable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Received</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tasksBody">
                        <tr><td colspan="6" class="text-center text-muted py-4">Loading tasks…</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Modals -->
    <!-- Assign Drafter Modal -->
    <div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content glass">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Drafter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="assignForm">
                        <input type="hidden" id="assignInstructionId" />
                        <div class="mb-3">
                            <label for="drafterSelect" class="form-label">Select Drafter</label>
                            <select id="drafterSelect" class="form-select" required></select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="assignConfirmBtn">Assign</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 700, easing: 'ease-out-cubic', once: true, offset: 80 });

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');
            if (!token) { window.location.href = 'login.html'; return; }
            const tasksBody = document.getElementById('tasksBody');
            const searchInput = document.getElementById('searchInput');

            // Load navigation counts for notifications, messages and tasks
            async function loadNavCounts() {
                try {
                    const res = await fetch('/api/Dashboard/UserCounts', { headers: { Authorization: 'Bearer ' + token } });
                    if (!res.ok) return;
                    const counts = await res.json();
                    document.getElementById('notifCount').textContent = counts.notifications ?? counts.Notifications ?? 0;
                    document.getElementById('msgCount').textContent = counts.messages ?? counts.Messages ?? 0;
                    document.getElementById('taskCount').textContent = counts.tasks ?? counts.Tasks ?? 0;
                } catch (e) { }
            }

            // Hide nav items based on roles stored in the JWT token
            function applyRoleVisibility() {
                document.querySelectorAll('[data-roles]').forEach(el => {
                    const allowed = el.getAttribute('data-roles').split(',').map(s => s.trim());
                    if (!allowed.includes('All') && !allowed.some(r => roles.includes(r))) {
                        el.style.display = 'none';
                    }
                });
            }

            // Decode JWT payload to get roles
            let roles = [];
            let payload = {};
            try {
                payload = JSON.parse(atob((token.split('.')[1] || '')));
                const roleClaims = ['role','roles','http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];
                roleClaims.forEach(k => {
                    const v = payload[k];
                    if (Array.isArray(v)) roles = roles.concat(v);
                    else if (typeof v === 'string') roles.push(v);
                });
            } catch (e) { roles = []; }

            applyRoleVisibility();

            // Fetch tasks for the current user
            function fetchTasks() {
                return fetch('/api/tasks/user', { headers: { Authorization: 'Bearer ' + token } })
                    .then(res => res.ok ? res.json() : Promise.reject(res))
                    .catch(() => []);
            }

            // Render tasks table based on API results
            function renderTasksTable(tasks) {
                const term = searchInput.value.trim().toLowerCase();
                const filtered = tasks.filter(t => {
                    if (!term) return true;
                    return (t.Title || '').toLowerCase().includes(term) || (t.TaskType || '').toLowerCase().includes(term);
                });
                if (filtered.length === 0) {
                    tasksBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No tasks found.</td></tr>';
                    return;
                }
                tasksBody.innerHTML = '';
                filtered.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${t.Title || '(no title)'}</td>
                        <td>${t.TaskType || ''}</td>
                        <td>${t.Status || ''}</td>
                        <td>${new Date(t.CreatedAt).toLocaleDateString()}</td>
                        <td></td>`;
                    const actionCell = tr.lastElementChild;
                    // Determine action based on task type
                    if (t.TaskType === 'Draft') {
                        const link = document.createElement('a');
                        link.className = 'btn btn-sm btn-success';
                        link.innerHTML = '<i class="bi bi-pencil-square me-1"></i>Edit';
                        link.href = `drafter-dashboard.html`; // optional: pass instructionId via query
                        actionCell.appendChild(link);
                    } else if (t.TaskType === 'Registry Logging') {
                        const link = document.createElement('a');
                        link.className = 'btn btn-sm btn-primary';
                        link.innerHTML = '<i class="bi bi-archive me-1"></i>Log';
                        link.href = 'registry-logging.html';
                        actionCell.appendChild(link);
                    } else if (t.TaskType === 'PC Review' || t.TaskType === 'Approval') {
                        const link = document.createElement('a');
                        link.className = 'btn btn-sm btn-warning';
                        link.innerHTML = '<i class="bi bi-eye me-1"></i>Review';
                        link.href = 'seniorpc-review.html';
                        actionCell.appendChild(link);
                    } else if (t.TaskType === 'Ministry Response') {
                        const span = document.createElement('span');
                        span.className = 'text-muted';
                        span.textContent = 'Respond via Email';
                        actionCell.appendChild(span);
                    } else if (t.TaskType === 'Admin Comment') {
                        const span = document.createElement('span');
                        span.className = 'text-muted';
                        span.textContent = 'Follow up';
                        actionCell.appendChild(span);
                    } else {
                        actionCell.textContent = '-';
                    }
                    tasksBody.appendChild(tr);
                });
            }

            // Initial load and search handler
            function loadTasks() {
                fetchTasks().then(data => {
                    renderTasksTable(data);
                });
            }

            // Search input listener
            searchInput.addEventListener('input', () => {
                fetchTasks().then(renderTasksTable);
            });

            // Logout handler
            document.getElementById('logoutLink').addEventListener('click', e => {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                }
            });

            // Refresh tasks and nav counts periodically
            loadTasks();
            loadNavCounts();
            setInterval(() => {
                loadTasks();
                loadNavCounts();
            }, 60000);
        });
    </script>
</body>
</html>