<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard | OPC E‑Filing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: Inter, sans-serif; background: #f9fafb; min-height: 100vh; display:flex; flex-direction:column; }
        .navbar { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.06); }
        .main-wrap { flex:1; padding: 1rem; }
        .card-icon { font-size: 1.8rem; margin-right: 0.5rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
                <img src="https://www.gov.ls/wp-content/uploads/2017/08/cropped-cropped-1162px-Coat_of_arms_of_Lesotho.svg_-1.png" width="32" height="32" alt="Lesotho Coat of Arms">
                <span class="fw-bold">OPC <span class="text-primary">E‑Filing</span></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="nav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
                    <li class="nav-item" data-roles="All"><a class="nav-link active" aria-current="page" href="dashboard.html"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link" href="instructions.html"><i class="bi bi-card-list me-1"></i>Instructions</a></li>
                    <li class="nav-item" data-roles="All"><a class="nav-link" href="tasks.html"><i class="bi bi-list-check me-1"></i>My Tasks</a></li>
                    <li class="nav-item" data-roles="All"><a class="nav-link" href="timeline.html"><i class="bi bi-clock-history me-1"></i>Timeline</a></li>
                    <li class="nav-item" data-roles="SeniorPC,Admin"><a class="nav-link" href="signatures.html"><i class="bi bi-pencil-square me-1"></i>Signatures</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link" href="templates.html"><i class="bi bi-layout-text-window me-1"></i>Templates</a></li>
                    <!-- Notification, message and task icons with badges -->
                    <li class="nav-item position-relative" id="navNotifications" data-roles="Drafter,PC,RegistryOfficer,SeniorPC,Admin"><a class="nav-link" href="#" title="Notifications"><i class="bi bi-bell"></i><span class="badge rounded-pill bg-danger position-absolute top-0 start-100 translate-middle" id="notifCount" style="font-size:.6rem;">0</span></a></li>
                    <li class="nav-item position-relative" id="navMessages"><a class="nav-link" href="#" title="Messages"><i class="bi bi-envelope"></i><span class="badge rounded-pill bg-success position-absolute top-0 start-100 translate-middle" id="msgCount" style="font-size:.6rem;">0</span></a></li>
                    <li class="nav-item position-relative" id="navTaskIcon" data-roles="All"><a class="nav-link" href="tasks.html" title="My Tasks"><i class="bi bi-clipboard-check"></i><span class="badge rounded-pill bg-warning text-dark position-absolute top-0 start-100 translate-middle" id="taskCount" style="font-size:.6rem;">0</span></a></li>
                    <li class="nav-item"><a class="nav-link" href="profile.html"><i class="bi bi-person-circle me-1"></i>Profile</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-1"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <main class="container main-wrap mt-4">
        <h2 class="fw-bold mb-3" id="welcomeMessage">Welcome</h2>
        <!-- Notification bar -->
        <div class="d-flex mb-3 gap-3">
            <div class="badge bg-primary text-white p-3 flex-fill"><i class="bi bi-bell-fill card-icon"></i>Notifications <span id="badgeNotifications" class="badge bg-light text-primary">0</span></div>
            <div class="badge bg-success text-white p-3 flex-fill"><i class="bi bi-envelope-fill card-icon"></i>Messages <span id="badgeMessages" class="badge bg-light text-success">0</span></div>
            <div class="badge bg-warning text-white p-3 flex-fill"><i class="bi bi-clipboard-check-fill card-icon"></i>Tasks <span id="badgeTasks" class="badge bg-light text-warning">0</span></div>
        </div>
        <!-- Instruction status cards -->
        <div class="row g-3 mb-4" id="statusCards">
            <div class="col-md-2 col-6"><div class="card text-center shadow-sm"><div class="card-body"><h6>Submitted</h6><h4 id="countSubmitted">0</h4></div></div></div>
            <div class="col-md-2 col-6"><div class="card text-center shadow-sm"><div class="card-body"><h6>Logged</h6><h4 id="countLogged">0</h4></div></div></div>
            <div class="col-md-2 col-6"><div class="card text-center shadow-sm"><div class="card-body"><h6>Assigned</h6><h4 id="countAssigned">0</h4></div></div></div>
            <div class="col-md-2 col-6"><div class="card text-center shadow-sm"><div class="card-body"><h6>Drafting</h6><h4 id="countDrafting">0</h4></div></div></div>
            <div class="col-md-2 col-6"><div class="card text-center shadow-sm"><div class="card-body"><h6>Completed</h6><h4 id="countCompleted">0</h4></div></div></div>
        </div>
        <!-- Charts -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header">Drafts Over Time</div>
                    <div class="card-body">
                        <canvas id="draftChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header">Submission by Department</div>
                    <div class="card-body">
                        <canvas id="deptChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer class="py-4">
        <div class="container text-center small text-muted">© 2025 Government of Lesotho · Office of Parliamentary Counsel</div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('jwtToken');
        if (!token) window.location.href = 'login.html';
        document.getElementById('logoutLink').onclick = e => {
            e.preventDefault();
            if (confirm('Logout?')) { localStorage.removeItem('jwtToken'); window.location.href = 'login.html'; }
        };
        // Load counts and user info
        async function loadDashboard() {
            try {
                const userRes = await fetch('/api/Dashboard/UserInfo', { headers: { Authorization: 'Bearer ' + token } });
                const userInfo = await userRes.json();
                document.getElementById('welcomeMessage').textContent = `Welcome, ${userInfo.name}`;
                const countRes = await fetch('/api/Dashboard/InstructionCounts', { headers: { Authorization: 'Bearer ' + token } });
                const counts = await countRes.json();
                document.getElementById('countSubmitted').textContent = counts.submitted;
                document.getElementById('countLogged').textContent = counts.logged;
                document.getElementById('countAssigned').textContent = counts.assigned;
                document.getElementById('countDrafting').textContent = counts.drafting;
                document.getElementById('countCompleted').textContent = counts.completed;
                const userCountsRes = await fetch('/api/Dashboard/UserCounts', { headers: { Authorization: 'Bearer ' + token } });
                const uc = await userCountsRes.json();
                document.getElementById('badgeNotifications').textContent = uc.notifications;
+                document.getElementById('badgeMessages').textContent = uc.messages;
                document.getElementById('badgeTasks').textContent = uc.tasks;
            } catch (e) {
                console.warn('Dashboard load error', e);
            }
            // Dummy chart data
            const ctx1 = document.getElementById('draftChart').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['Jan','Feb','Mar','Apr','May','Jun'],
                    datasets: [{ label: 'Drafts', data: [5,8,3,6,9,4] }]
                },
                options: { plugins: { legend: { display: false } } }
            });
            const ctx2 = document.getElementById('deptChart').getContext('2d');
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Justice','Finance','Health','Education'],
                    datasets: [{ label: 'Submissions', data: [3,7,2,5] }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }
        loadDashboard();
    </script>
</body>
</html>