<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Drafter Dashboard | OPC E-Filing</title>

    <!-- Fonts & Styles -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        body {
            font-family: Inter, system-ui, sans-serif;
            background: #f9fafb;
            color: #1f2a44;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .brand-mark img {
            width: 32px;
            height: 32px;
        }

        .main-wrap {
            flex: 1;
            padding: 1.5rem;
        }

        .tinymce-container {
            background: #fff;
            box-shadow: 0 0 25px rgba(0,0,0,.1);
            border-radius: 8px;
            overflow: hidden;
            height: calc(100vh - 160px);
        }

        footer {
            padding: 1rem 0;
            background: #f1f3f5;
            text-align: center;
            font-size: 0.9rem;
            color: #555;
        }
    </style>

    <!-- TinyMCE Word-like full screen build (Free CDN) -->
    <script src="https://cdn.tiny.cloud/1/1671pwl34tzqa6fx3goy88omtg3dakzjysgxndavzrkktxed/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand brand-mark fw-bold d-flex align-items-center gap-2" href="index.html">
                <img src="https://www.gov.ls/wp-content/uploads/2017/08/cropped-cropped-1162px-Coat_of_arms_of_Lesotho.svg_-1.png">
                <span>OPC <span class="text-primary">E-Filing</span></span>
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto gap-3">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="instructions.html">Instructions</a></li>
                    <li class="nav-item"><a class="nav-link active" href="drafter-dashboard.html">Drafter Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="templates.html">Templates</a></li>
                    <li class="nav-item"><a class="nav-link" href="search.html">Search</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutLink">Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid main-wrap">
        <h2 class="fw-bold mb-3">Drafter Dashboard</h2>
        <div class="row">
            <div class="col-lg-4 mb-3">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-inbox me-2"></i>Assigned to Me</span>
                        <button id="btnRefresh" class="btn btn-sm btn-light"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div id="assignedList" class="list-group list-group-flush"></div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h5 id="briefTitle" class="fw-bold">No instruction selected</h5>
                        <p id="briefDesc" class="text-muted mb-2">Select an instruction from the left panel to begin drafting.</p>
                        <div class="small text-muted" id="briefMeta"></div>
                    </div>
                </div>
                <div class="tinymce-container">
                    <textarea id="lawEditor"></textarea>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button id="btnSave" class="btn btn-outline-primary"><i class="bi bi-save me-1"></i>Save Draft</button>
                    <button id="btnSubmit" class="btn btn-success"><i class="bi bi-send me-1"></i>Submit Draft</button>
                    <span id="saveStatus" class="ms-auto small text-muted"></span>
                </div>
                <div id="draftMessage" class="mt-2 small text-danger fw-semibold"></div>
            </div>
        </div>
    </main>

    <footer>
        © 2025 Government of Lesotho · Office of Parliamentary Counsel
    </footer>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = localStorage.getItem('jwtToken');
        if (!token) window.location.href = 'login.html';

        const listEl = document.getElementById('assignedList');
        const saveBtn = document.getElementById('btnSave');
        const submitBtn = document.getElementById('btnSubmit');
        const saveStatus = document.getElementById('saveStatus');
        const draftMessage = document.getElementById('draftMessage');
        const briefTitle = document.getElementById('briefTitle');
        const briefDesc = document.getElementById('briefDesc');
        const briefMeta = document.getElementById('briefMeta');
        let selectedInstructionId = null;

        // Load TinyMCE
        tinymce.init({
            selector: '#lawEditor',
            height: "100%",
            menubar: 'file edit view insert format tools table help',
            plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount export',
            toolbar: 'undo redo | styles | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image table | export print | fullscreen',
            branding: false,
            skin: "oxide",
            content_css: "document",
            toolbar_sticky: true,
            autosave_interval: '30s',
            autosave_restore_when_empty: true,
            export_filetype: 'docx,pdf',
            setup: (editor) => { window.editor = editor; }
        });

        async function loadAssigned() {
            saveStatus.textContent = 'Loading...';
            try {
                const res = await fetch('/api/drafts/All', { headers: { Authorization: 'Bearer ' + token } });
                const data = await res.json();
                renderAssignedList(data);
                if (data.length) pickInstruction(data[0].draftingInstructionID);
                else saveStatus.textContent = 'No assigned instructions';
            } catch {
                saveStatus.textContent = 'Failed to load assignments';
            }
        }

        function renderAssignedList(items) {
            listEl.innerHTML = '';
            items.forEach(i => {
                const btn = document.createElement('button');
                btn.className = 'list-group-item list-group-item-action';
                btn.textContent = i.title || ('Instruction #' + i.draftingInstructionID);
                btn.onclick = () => pickInstruction(i.draftingInstructionID);
                listEl.appendChild(btn);
            });
        }

        async function pickInstruction(id) {
            selectedInstructionId = id;
            try {
                const res = await fetch(`/api/DraftingInstructions/${id}`, { headers: { Authorization: 'Bearer ' + token } });
                const d = await res.json();
                briefTitle.textContent = d.title || ('Instruction #' + id);
                briefDesc.textContent = d.description || '';
                briefMeta.textContent = d.receivedDate ? new Date(d.receivedDate).toLocaleString() : '';
            } catch { }
            loadDraft(id);
        }

        async function loadDraft(id) {
            try {
                const res = await fetch(`/api/drafts/ByInstruction/${id}`, { headers: { Authorization: 'Bearer ' + token } });
                const d = await res.json();
                tinymce.get('lawEditor').setContent(d.contentHtml || '');
                saveStatus.textContent = 'Last saved: ' + new Date(d.lastModifiedAt || Date.now()).toLocaleString();
            } catch {
                saveStatus.textContent = 'No draft yet';
            }
        }

        saveBtn.onclick = async () => {
            if (!selectedInstructionId) return;
            const content = tinymce.get('lawEditor').getContent();
            try {
                await fetch('/api/drafts/Save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                    body: JSON.stringify({ draftingInstructionID: selectedInstructionId, htmlContent: content })
                });
                saveStatus.textContent = 'Saved at ' + new Date().toLocaleTimeString();
            } catch {
                saveStatus.textContent = 'Save failed';
            }
        };

        submitBtn.onclick = async () => {
            if (!selectedInstructionId) return;
            if (!confirm('Submit this draft? You will not be able to edit it after submission.')) return;
            const content = tinymce.get('lawEditor').getContent();
            try {
                const res = await fetch('/api/drafts/Submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                    body: JSON.stringify({ draftingInstructionID: selectedInstructionId, htmlContent: content })
                });
                const result = await res.json();
                draftMessage.textContent = result.message || 'Draft submitted successfully!';
            } catch {
                draftMessage.textContent = 'Submission failed.';
            }
        };

        document.getElementById('btnRefresh').onclick = loadAssigned;
        loadAssigned();
    </script>
</body>
</html>
