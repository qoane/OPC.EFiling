<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Drafter Dashboard | OPC E‑Filing</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <!-- CKEditor 5 Document build for Word‑like editing -->
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/decoupled-document/ckeditor.js"></script>
    <!-- Free libraries for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.1/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --les-blue: #0c4ad4;
            --les-green: #1f8a43;
            --ink-900: #0b1020;
            --ink-700: #1f2a44;
            --ink-500: #4b587a;
            --nude-10: #fdfcfb;
            --nude-25: #fbf8f5;
            --nude-50: #f7f3ef;
        }
        body {
            font-family: Inter, sans-serif;
            background: radial-gradient(1200px 800px at 10% -10%, var(--nude-10), var(--nude-25)), radial-gradient(1000px 700px at 110% 10%, var(--nude-50), var(--nude-10));
            color: var(--ink-700);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        .navbar-nav .nav-link.active {
            font-weight: 600;
            color: var(--les-blue) !important;
        }
        .main-wrap {
            flex: 1;
            padding: 1rem;
        }
        .instructions-panel {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .doc-container {
            position: relative;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
            background: #ffffff;
            border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 6px;
            overflow: hidden;
        }
        .doc-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .doc-editor {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        /* Comments toggle button */
        #toggleCommentsBtn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1050;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--les-blue);
            color: #fff;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        /* Comments sidebar placeholder in layout (invisible until component loaded) */
        #commentsSidebar {
            position: fixed;
            top: 70px;
            right: 0;
            bottom: 0;
            width: 360px;
            display: none;
            z-index: 1040;
        }
    </style>
</head>
<body>
    <!-- Navigation bar -->
    <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
                <img src="https://www.gov.ls/wp-content/uploads/2017/08/cropped-cropped-1162px-Coat_of_arms_of_Lesotho.svg_-1.png" alt="Lesotho Coat of Arms" width="32" height="32">
                <span class="fw-bold">OPC <span class="text-primary">E‑Filing</span></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="nav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
                    <li class="nav-item" data-roles="All"><a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link" href="instructions.html"><i class="bi bi-card-list me-1"></i>Instructions</a></li>
                    <li class="nav-item" data-roles="All"><a class="nav-link" href="tasks.html"><i class="bi bi-list-check me-1"></i>My Tasks</a></li>
                    <li class="nav-item" data-roles="MDA"><a class="nav-link" href="submit-instruction.html"><i class="bi bi-plus-circle me-1"></i>New Instruction</a></li>
                    <li class="nav-item" data-roles="PC"><a class="nav-link" href="pc-allocation.html"><i class="bi bi-person-plus me-1"></i>PC Allocation</a></li>
                    <li class="nav-item" data-roles="RegistryOfficer"><a class="nav-link" href="registry-logging.html"><i class="bi bi-archive me-1"></i>Registry Logging</a></li>
                    <li class="nav-item" data-roles="Drafter"><a class="nav-link active" aria-current="page" href="drafter-dashboard.html"><i class="bi bi-journal-text me-1"></i>Drafter Dashboard</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link" href="search.html"><i class="bi bi-search me-1"></i>Search</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link" href="templates.html"><i class="bi bi-layout-text-window me-1"></i>Templates</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link" href="circulation.html"><i class="bi bi-send me-1"></i>Circulation</a></li>
                    <li class="nav-item" data-roles="Admin"><a class="nav-link" href="manage-users.html"><i class="bi bi-people me-1"></i>User Management</a></li>
                    <!-- Notification, message and task icons with badges -->
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="#" title="Notifications">
                            <i class="bi bi-bell"></i>
                            <span id="navNotifBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="#" title="Messages">
                            <i class="bi bi-envelope"></i>
                            <span id="navMsgBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="tasks.html" title="My Tasks">
                            <i class="bi bi-clipboard-check"></i>
                            <span id="navTaskBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">0</span>
                        </a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="profile.html"><i class="bi bi-person-circle me-1"></i>Profile</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-1"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container-fluid main-wrap mt-4">
        <h2 class="fw-bold mb-3">Drafter Dashboard</h2>
        <div class="row">
            <!-- Left column: assigned instructions -->
            <div class="col-lg-3 mb-3">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-inbox me-2"></i>Assigned Instructions</span>
                        <button id="btnRefresh" class="btn btn-sm btn-light"><i class="bi bi-arrow-clockwise"></i></button>
                    </div>
                    <div class="card-body instructions-panel p-0">
                        <div id="assignedList" class="list-group list-group-flush"></div>
                    </div>
                </div>
            </div>
            <!-- Right column: editor and toolbar -->
            <div class="col-lg-9">
                <div class="doc-container mb-3">
                    <div class="doc-toolbar">
                        <div>
                            <strong id="docTitle">No instruction selected</strong>
                            <small id="docStatus" class="text-muted ms-2"></small>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <!-- File menu dropdown -->
                            <div class="dropdown">
                                <button class="btn btn-light dropdown-toggle" type="button" id="fileMenuBtn" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-file-earmark-text me-1"></i> File
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="fileMenuBtn">
                                    <li><a class="dropdown-item" href="#" id="btnSave">Save Draft</a></li>
                                    <li><a class="dropdown-item" href="#" id="btnSubmit">Submit Draft</a></li>
                                    <li><a class="dropdown-item" href="#" id="btnExportWord">Export as Word</a></li>
                                    <li><a class="dropdown-item" href="#" id="btnExportPdf">Export as PDF</a></li>
                                </ul>
                            </div>
                            <button class="btn btn-outline-primary" id="btnCommentsToggle"><i class="bi bi-chat-square-dots me-1"></i>Comments</button>
                        </div>
                    </div>
                    <!-- CKEditor toolbar placeholder -->
                    <div id="editorToolbar"></div>
                    <!-- Editor area -->
                    <div id="editor" class="doc-editor"></div>
                </div>
                <div id="saveStatus" class="small text-muted"></div>
                <div id="draftMessage" class="mt-2 small fw-semibold text-danger"></div>
            </div>
        </div>
    </main>

    <!-- Comments sidebar (loaded dynamically from components/comments-sidebar.html) -->
    <div id="commentsSidebar"></div>
    <button id="toggleCommentsBtn" title="Comments" style="display:none;"><i class="bi bi-chat-text"></i></button>

    <!-- Footer -->
    <footer class="py-4">
        <div class="container text-center small text-muted">
            © 2025 Government of Lesotho · Office of Parliamentary Counsel
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JWT guard: redirect to login if token missing
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            window.location.href = 'login.html';
        }

        // Load notification/message/task counts for nav badges
        async function loadNavCounts() {
            try {
                const res = await fetch('/api/Dashboard/UserCounts', { headers: { Authorization: 'Bearer ' + token } });
                if (res.ok) {
                    const data = await res.json();
                    const n = document.getElementById('navNotifBadge');
                    const m = document.getElementById('navMsgBadge');
                    const t = document.getElementById('navTaskBadge');
                    if (n) n.textContent = data.notifications;
                    if (m) m.textContent = data.messages;
                    if (t) t.textContent = data.tasks;
                }
            } catch (e) {
                console.warn('Failed to load nav counts', e);
            }
        }

        // Roles-based navigation display
        document.addEventListener('DOMContentLoaded', () => {
            const payload = JSON.parse(atob(token.split('.')[1] || '{}'));
            let roles = [];
            if (payload.role) roles = Array.isArray(payload.role) ? payload.role : [payload.role];
            if (payload.roles) roles = roles.concat(Array.isArray(payload.roles) ? payload.roles : [payload.roles]);
            document.querySelectorAll('[data-roles]').forEach(item => {
                const allowed = item.getAttribute('data-roles').split(',').map(s => s.trim());
                if (!allowed.includes('All') && !allowed.some(r => roles.includes(r))) {
                    item.style.display = 'none';
                }
            });
            // Logout
            document.getElementById('logoutLink').addEventListener('click', e => {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('jwtToken');
                    window.location.href = 'login.html';
                }
            });

            // Load nav counts on page load
            loadNavCounts();
            // Refresh counts every 5 minutes
            setInterval(loadNavCounts, 5 * 60 * 1000);
        });

        // Elements
        const assignedListEl = document.getElementById('assignedList');
        const docTitleEl = document.getElementById('docTitle');
        const docStatusEl = document.getElementById('docStatus');
        const saveStatusEl = document.getElementById('saveStatus');
        const draftMessageEl = document.getElementById('draftMessage');

        let editorInstance;
        let currentInstructionId = null;
        let heartbeatTimer = null;
        let autosaveTimer = null;

        // Load CKEditor
        DecoupledDocumentEditor.create(document.querySelector('#editor'), {
            placeholder: 'Start drafting here…',
            toolbar: {
                items: [
                    'undo', 'redo', '|', 'heading', '|', 'bold', 'italic', 'underline', 'strikethrough', '|',
                    'bulletedList', 'numberedList', '|', 'link', 'insertTable', 'imageUpload', 'mediaEmbed', '|',
                    'alignment', '|', 'blockQuote', 'codeBlock', 'pageBreak'
                ]
            }
        }).then(editor => {
            editorInstance = editor;
            // Place toolbar in our container
            document.getElementById('editorToolbar').appendChild(editor.ui.view.toolbar.element);
            loadAssigned();
        });

        async function loadAssigned() {
            assignedListEl.innerHTML = '<div class="list-group-item text-muted">Loading…</div>';
            try {
                const res = await fetch('/api/drafts/All', { headers: { Authorization: 'Bearer ' + token } });
                const data = await res.json();
                assignedListEl.innerHTML = '';
                data.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = 'list-group-item list-group-item-action';
                    btn.textContent = item.title || ('Instruction #' + item.draftingInstructionID);
                    btn.onclick = () => pickInstruction(item.draftingInstructionID);
                    assignedListEl.appendChild(btn);
                });
            } catch {
                assignedListEl.innerHTML = '<div class="list-group-item text-danger">Failed to load instructions</div>';
            }
        }

        async function pickInstruction(id) {
            currentInstructionId = id;
            draftMessageEl.textContent = '';
            // load brief
            try {
                const res = await fetch('/api/DraftingInstructions/' + id, { headers: { Authorization: 'Bearer ' + token } });
                if (res.ok) {
                    const d = await res.json();
                    docTitleEl.textContent = d.title || ('Instruction #' + id);
                    docStatusEl.textContent = d.status ? '(' + d.status + ')' : '';
                }
            } catch {}
            // load draft
            try {
                const res = await fetch('/api/drafts/ByInstruction/' + id, { headers: { Authorization: 'Bearer ' + token } });
                if (res.ok) {
                    const draft = await res.json();
                    editorInstance.setData(draft.contentHtml || '');
                    saveStatusEl.textContent = 'Last saved: ' + new Date(draft.lastModifiedAt || draft.createdAt).toLocaleString();
                } else {
                    editorInstance.setData('');
                    saveStatusEl.textContent = 'No draft yet';
                }
            } catch {
                editorInstance.setData('');
                saveStatusEl.textContent = 'Error loading draft';
            }
            // start timers
            startHeartbeat();
            startAutosave();
            // Load comments
            loadCommentsComponent();
            loadCommentsSidebar(id);
        }

        // Timers
        function startHeartbeat() {
            if (heartbeatTimer) clearInterval(heartbeatTimer);
            heartbeatTimer = setInterval(() => {
                if (!currentInstructionId) return;
                fetch('/api/draftlock/heartbeat/' + currentInstructionId, { method: 'POST', headers: { Authorization: 'Bearer ' + token } })
                    .then(res => { if (!res.ok) { console.warn('Lock lost'); } });
            }, 5 * 60 * 1000);
        }
        function startAutosave() {
            if (autosaveTimer) clearInterval(autosaveTimer);
            autosaveTimer = setInterval(() => saveDraft(true), 60 * 1000);
        }

        // Save & Submit
        async function saveDraft(silent) {
            if (!currentInstructionId) return;
            const content = editorInstance.getData();
            try {
                await fetch('/api/drafts/Save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                    body: JSON.stringify({ draftingInstructionID: currentInstructionId, htmlContent: content })
                });
                if (!silent) saveStatusEl.textContent = 'Saved at ' + new Date().toLocaleTimeString();
            } catch {
                if (!silent) saveStatusEl.textContent = 'Failed to save';
            }
        }
        async function submitDraft() {
            if (!currentInstructionId) return;
            if (!confirm('Submit this draft? You will not be able to edit it after submission.')) return;
            const content = editorInstance.getData();
            draftMessageEl.textContent = '';
            try {
                const res = await fetch('/api/drafts/Submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
                    body: JSON.stringify({ draftingInstructionID: currentInstructionId, htmlContent: content })
                });
                const result = await res.json().catch(() => ({ message: 'Draft submitted' }));
                draftMessageEl.textContent = result.message || 'Submitted!';
            } catch {
                draftMessageEl.textContent = 'Submission failed';
            }
        }

        document.getElementById('btnSave').addEventListener('click', e => { e.preventDefault(); saveDraft(false); });
        document.getElementById('btnSubmit').addEventListener('click', e => { e.preventDefault(); submitDraft(); });

        // Exports
        document.getElementById('btnExportWord').addEventListener('click', e => { e.preventDefault(); exportWord(); });
        document.getElementById('btnExportPdf').addEventListener('click', e => { e.preventDefault(); exportPdf(); });

        function exportWord() {
            if (!editorInstance) return;
            const html = '<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>' + editorInstance.getData() + '</body></html>';
            const converted = window.htmlDocx.asBlob(html);
            const fileName = (docTitleEl.textContent || 'draft') + '.docx';
            saveAs(converted, fileName);
        }
        function exportPdf() {
            const element = document.createElement('div');
            element.innerHTML = editorInstance.getData();
            const opt = { margin: 1, filename: (docTitleEl.textContent || 'draft') + '.pdf', html2canvas: { scale: 1 }, jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' } };
            html2pdf().from(element).set(opt).save();
        }

        // Comments integration
        document.getElementById('btnCommentsToggle').addEventListener('click', e => {
            e.preventDefault();
            toggleCommentsSidebar();
        });
        function loadCommentsComponent() {
            if (document.getElementById('commentsSidebar').innerHTML.trim() !== '') return;
            fetch('components/comments-sidebar.html')
                .then(res => res.text())
                .then(html => {
                    document.getElementById('commentsSidebar').innerHTML = html;
                    // Show floating toggle
                    document.getElementById('toggleCommentsBtn').style.display = 'flex';
                    document.getElementById('toggleCommentsBtn').addEventListener('click', () => toggleCommentsSidebar());
                });
        }

        // Toggle Comments sidebar visibility
        function toggleCommentsSidebar(forceShow) {
            const sidebar = document.getElementById('commentsSidebar');
            const isVisible = sidebar.style.display !== 'none' && sidebar.style.display !== '';
            const show = forceShow !== undefined ? forceShow : !isVisible;
            sidebar.style.display = show ? 'block' : 'none';
        }

    </script>
</body>
</html>