<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OPC E-Filing — User Management</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />

    <style>
        :root {
            --les-blue: #0c4ad4;
            --les-green: #1f8a43;
            --ink-900: #0b1020;
            --ink-700: #1f2a44;
            --nude-10: #fdfcfb;
            --nude-25: #fbf8f5;
            --nude-50: #f7f3ef;
            --glass-bg: 24,36,66;
            --glass-alpha: .55;
            --radius-2xl: 22px;
            --shadow-md: 0 10px 30px rgba(11,16,32,.15);
            --chip-bg: #fff;
            --chip-br: rgba(0,0,0,.08);
        }

        html, body {
            height: 100%
        }

        body {
            font-family: Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
            color: var(--ink-700);
            background: radial-gradient(1200px 800px at 10% -10%, var(--nude-10), var(--nude-25)), radial-gradient(1000px 700px at 110% 10%, var(--nude-50), var(--nude-10));
            overflow-x: hidden;
            padding-top: 72px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .flag-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1040;
            box-shadow: 0 2px 10px rgba(0,0,0,.06)
        }

            .flag-bar .bar {
                height: 6px
            }

        .flag-blue {
            background: var(--les-blue)
        }

        .flag-white {
            background: #fff
        }

        .flag-green {
            background: var(--les-green)
        }

        .orb {
            position: absolute;
            filter: blur(40px);
            opacity: .28;
            z-index: 0
        }

            .orb.blue {
                background: radial-gradient(circle at 40% 40%, #2e6cff, rgba(46,108,255,0) 60%)
            }

            .orb.green {
                background: radial-gradient(circle at 60% 60%, #3ecf6d, rgba(62,207,109,0) 60%)
            }

            .orb.nude {
                background: radial-gradient(circle at 50% 50%, #ffe8d8, rgba(255,232,216,0) 60%)
            }

            .orb.size-lg {
                width: 520px;
                height: 520px;
                border-radius: 50%
            }

            .orb.size-md {
                width: 360px;
                height: 360px;
                border-radius: 50%
            }

            .orb.size-sm {
                width: 220px;
                height: 220px;
                border-radius: 50%
            }

        @keyframes floaty {
            0% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-18px)
            }

            100% {
                transform: translateY(0)
            }
        }

        .animate-float {
            animation: floaty 10s ease-in-out infinite
        }

        .glass {
            background: rgba(var(--glass-bg),var(--glass-alpha));
            backdrop-filter: blur(14px) saturate(130%);
            -webkit-backdrop-filter: blur(14px) saturate(130%);
            border: 1px solid rgba(255,255,255,.25);
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-2xl)
        }

        .modal-content.solid {
            background: #fff;
            color: #1b243a;
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-md)
        }

        .navbar.glassy {
            background: rgba(255,255,255,.7) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,.06)
        }

        .brand-mark {
            display: flex;
            align-items: center;
            gap: .6rem;
            font-weight: 800;
            color: #0b1020
        }

            .brand-mark img {
                width: 32px;
                height: 32px
            }

        .page-header {
            position: relative;
            padding: 36px 0 16px
        }

            .page-header .halo {
                position: absolute;
                inset: -40px -40px -20px -40px;
                pointer-events: none;
                z-index: 0;
                background: radial-gradient(900px 500px at 45% -10%, rgba(12,74,212,.18), rgba(12,74,212,0) 60%), radial-gradient(800px 480px at 80% 10%, rgba(31,138,67,.16), rgba(31,138,67,0) 60%);
            }

            .page-header .inner {
                position: relative;
                z-index: 1
            }

        .filters.glass {
            padding: 14px
        }

        .chip {
            padding: .35rem .6rem;
            border-radius: 999px;
            font-size: .85rem;
            background: var(--chip-bg);
            border: 1px solid var(--chip-br)
        }

        .btn-ghost {
            background: #fff;
            border: 1px solid rgba(11,16,32,.12)
        }

        .table-wrap.glass {
            padding: 0;
            overflow: hidden
        }

        .table thead th {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 1
        }

        .editable {
            box-shadow: 0 0 0 2px rgba(12,74,212,.15) inset;
            border-radius: 8px;
            background: #fff
        }

        .row-actions .btn {
            padding: .25rem .5rem
        }

        footer {
            background: linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,.9))
        }
    </style>
</head>
<body>
    <!-- Flag bar -->
    <div class="flag-bar">
        <div class="bar flag-blue"></div>
        <div class="bar flag-white"></div>
        <div class="bar flag-green"></div>
    </div>

    <!-- Orbs -->
    <div class="orb blue size-lg animate-float" style="top:-120px; left:-120px"></div>
    <div class="orb green size-md animate-float" style="bottom:10%; right:-80px; animation-delay:.6s"></div>
    <div class="orb nude size-sm animate-float" style="top:40%; left:10%"></div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg glassy fixed-top">
        <div class="container">
            <a class="navbar-brand brand-mark" href="dashboard.html">
                <img src="https://www.gov.ls/wp-content/uploads/2017/08/cropped-cropped-1162px-Coat_of_arms_of_Lesotho.svg_-1.png" alt="Lesotho Coat of Arms">
                <span>OPC <span class="text-primary">E-Filing</span></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="nav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-people me-1"></i>User Management</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-1"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- HEADER -->
    <header class="page-header">
        <div class="halo"></div>
        <div class="inner container" data-aos="fade-up">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                <div>
                    <h1 class="fw-bolder mb-1">User Management</h1>
                    <p class="text-muted mb-0">Admin-only · search, filter, inline edit, export.</p>
                </div>
                <div class="d-flex gap-2">
                    <button id="btnCreate" class="btn btn-ghost"><i class="bi bi-person-plus me-1"></i>Add User</button>
                    <button id="btnCreateAdmin" class="btn btn-ghost"><i class="bi bi-shield-lock me-1"></i>Create Admin</button>
                </div>
            </div>
        </div>
    </header>

    <!-- FILTERS -->
    <section class="container mb-3">
        <div class="filters glass" data-aos="zoom-in">
            <div class="row g-2 align-items-end">
                <div class="col-12 col-md-6">
                    <label class="form-label small">Search</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="q" class="form-control" placeholder="Name, email…" />
                    </div>
                </div>
                <div class="col-12 col-md-4">
                    <label class="form-label small">Department</label>
                    <select id="fDept" class="form-select">
                        <option value="">All</option>
                    </select>
                </div>
                <div class="col-12 col-md-2 d-grid">
                    <button id="btnClear" class="btn btn-ghost">Clear</button>
                </div>
            </div>
            <div class="d-flex gap-2 mt-2 small">
                <span id="countChip" class="chip">0 users</span>
                <button id="btnExport" class="btn btn-sm btn-ghost"><i class="bi bi-download me-1"></i>Export CSV</button>
            </div>
        </div>
    </section>

    <!-- TABLE -->
    <section class="container">
        <div class="table-wrap glass" data-aos="fade-up">
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="min-width:220px">Full name</th>
                            <th style="min-width:220px">Email</th>
                            <th>Department</th>
                            <th>Created</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>
            <div id="noData" class="p-4 text-center text-muted d-none">No users found.</div>
            <div class="d-flex align-items-center justify-content-between p-3 border-top">
                <div class="small text-muted">Page <span id="pageNum">1</span> of <span id="pageTotal">1</span></div>
                <div class="btn-group">
                    <button class="btn btn-ghost" id="prevPage"><i class="bi bi-chevron-left"></i></button>
                    <button class="btn btn-ghost" id="nextPage"><i class="bi bi-chevron-right"></i></button>
                </div>
            </div>
        </div>
    </section>

    <!-- CREATE ADMIN MODAL (solid for readability) -->
    <div class="modal fade" id="adminModal" tabindex="-1" aria-labelledby="adminModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content solid">
                <form id="adminForm" class="needs-validation" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="adminModalLabel">Create Admin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Admin email</label>
                            <input id="adminEmail" type="email" class="form-control" required />
                            <div class="invalid-feedback">Email is required.</div>
                        </div>
                        <div class="mb-1">
                            <label class="form-label">Password</label>
                            <input id="adminPassword" type="password" class="form-control" minlength="6" required />
                            <div class="invalid-feedback">Password is required (min 6 chars).</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- LOGOUT MODAL (solid) -->
    <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content solid">
                <div class="modal-header">
                    <h5 class="modal-title" id="logoutModalLabel">Confirm Logout</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">Are you sure you want to log out?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmLogout">Logout</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="py-4 mt-auto">
        <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
            <div class="d-flex align-items-center gap-2">
                <img src="https://www.gov.ls/wp-content/uploads/2017/08/cropped-cropped-1162px-Coat_of_arms_of_Lesotho.svg_-1.png" width="24" height="24" alt="Lesotho Coat of Arms">
                <span class="fw-bold">Office of Parliamentary Counsel</span>
            </div>
            <div class="small text-muted">© 2025 Government of Lesotho · All rights reserved</div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 700, easing: 'ease-out-cubic', once: true, offset: 80 });

        // --- Auth guard (admin/super admin) ---
        const token = localStorage.getItem('jwtToken');
        if (!token) { window.location.href = 'login.html'; }

        function decodeJwt(t) { try { return JSON.parse(atob(t.split('.')[1])); } catch { return {}; } }
        const payload = decodeJwt(token);
        const roleKeys = ['role', 'roles', 'http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];
        let roles = [];
        roleKeys.forEach(k => {
            const v = payload[k];
            if (Array.isArray(v)) roles = roles.concat(v);
            else if (typeof v === 'string') roles.push(v);
        });
        const email = (payload.email || payload.sub || '').toString().toLowerCase();
        const isAdmin = roles.map(r => String(r).toLowerCase()).includes('admin') || email === 'admin@opc.gov.ls';
        if (!isAdmin) { window.location.href = 'dashboard.html'; }

        // --- Lookups ---
        const DEPARTMENTS = [
            { id: 201, name: "Prime Minister's Office" },
            { id: 202, name: "Ministry of Law and Justice" },
            { id: 203, name: "Ministry of Finance and Development Planning" },
            { id: 204, name: "Ministry of Foreign Affairs and International Relations" },
            { id: 205, name: "Ministry of Education and Training" },
            { id: 206, name: "Ministry of Health" },
            { id: 207, name: "Ministry of Agriculture, Food Security and Nutrition" },
            { id: 208, name: "Ministry of Natural Resources" },
            { id: 209, name: "Ministry of Public Works and Transport" },
            { id: 210, name: "Ministry of Local Government, Chieftainship, Home Affairs and Police" },
            { id: 211, name: "Ministry of Information, Communications, Science, Technology and Innovation" },
            { id: 212, name: "Ministry of Trade, Industry and Small Business" },
            { id: 213, name: "Ministry of Gender, Youth and Social Development" },
            { id: 214, name: "Ministry of Public Service" },
            { id: 215, name: "Ministry of Energy" },
            { id: 216, name: "Ministry of Tourism, Sports, Arts and Culture" },
            { id: 217, name: "Ministry of Labour and Employment" },
            { id: 218, name: "Ministry of Environment and Forestry" }
        ];

        // --- Elements ---
        const q = document.getElementById('q');
        const fDept = document.getElementById('fDept');
        const btnClear = document.getElementById('btnClear');
        const btnExport = document.getElementById('btnExport');
        const tbody = document.getElementById('tbody');
        const noData = document.getElementById('noData');
        const pageNum = document.getElementById('pageNum');
        const pageTotal = document.getElementById('pageTotal');
        const adminModal = new bootstrap.Modal(document.getElementById('adminModal'));
        const logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));

        document.getElementById('logoutLink').addEventListener('click', (e) => { e.preventDefault(); logoutModal.show(); });
        document.getElementById('confirmLogout').addEventListener('click', () => { localStorage.removeItem('jwtToken'); window.location.href = 'login.html'; });
        document.getElementById('btnCreateAdmin').addEventListener('click', () => adminModal.show());
        document.getElementById('btnCreate').addEventListener('click', addInlineRow);

        // Fill department filter
        (function fillDeptFilter() {
            DEPARTMENTS.forEach(d => {
                const o = document.createElement('option');
                o.value = String(d.id);
                o.textContent = d.name;
                fDept.appendChild(o);
            });
        })();

        // Pagination + state
        let page = 1;
        const pageSize = 10;
        let all = [];
        let filtered = [];

        document.getElementById('prevPage').onclick = function () { if (page > 1) { page--; render(); } };
        document.getElementById('nextPage').onclick = function () {
            const total = Math.max(1, Math.ceil(filtered.length / pageSize));
            if (page < total) { page++; render(); }
        };

        // Load users
        (async function init() {
            await refreshUsers();
        })();

        async function refreshUsers() {
            try {
                const res = await fetch('/api/Users', { headers: { Authorization: 'Bearer ' + token } });
                if (!res.ok) { all = []; filtered = []; render(); return; }
                all = await res.json();
                applyFilters();
            } catch (e) {
                all = []; filtered = []; render();
            }
        }

        // Filters
        q.addEventListener('input', applyFilters);
        fDept.addEventListener('input', applyFilters);
        btnClear.addEventListener('click', function () {
            q.value = ''; fDept.value = ''; applyFilters();
        });

        function applyFilters() {
            const query = q.value.toLowerCase();
            filtered = all.filter(function (u) {
                const okQ = !query ||
                    (u.fullName || '').toLowerCase().includes(query) ||
                    (u.email || '').toLowerCase().includes(query);
                const okD = !fDept.value || String(u.departmentID) === String(fDept.value);
                return okQ && okD;
            });
            page = 1;
            render();
        }

        function deptName(id) {
            const hit = DEPARTMENTS.find(d => d.id === Number(id));
            return hit ? hit.name : 'Dept #' + id;
        }
        function fmtDate(d) { try { return new Date(d).toLocaleDateString(); } catch { return '—'; } }
        function esc(s) {
            return String(s || '').replace(/[&<>\"']/g, function (m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
            });
        }

        function render() {
            const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
            pageNum.textContent = String(page);
            pageTotal.textContent = String(totalPages);

            tbody.innerHTML = '';
            if (!filtered.length) { noData.classList.remove('d-none'); return; }
            noData.classList.add('d-none');

            const start = (page - 1) * pageSize;
            const slice = filtered.slice(start, start + pageSize);
            slice.forEach(function (u) { tbody.appendChild(rowTpl(u)); });
        }

        function rowTpl(u) {
            const tr = document.createElement('tr');
            tr.dataset.id = String(u.userID || u.id || '');
            // build department options
            var deptOpts = '';
            for (var i = 0; i < DEPARTMENTS.length; i++) {
                var d = DEPARTMENTS[i];
                var sel = (Number(u.departmentID) === d.id) ? ' selected' : '';
                deptOpts += '<option value="' + d.id + '"' + sel + '>' + esc(d.name) + '</option>';
            }
            tr.innerHTML =
                '<td>' +
                '<div class="d-flex align-items-center gap-2">' +
                '<input class="form-control form-control-sm d-none" data-edit="fullName" value="' + esc(u.fullName || '') + '">' +
                '<span data-view="fullName">' + esc(u.fullName || '') + '</span>' +
                '</div>' +
                '</td>' +
                '<td>' +
                '<input class="form-control form-control-sm d-none" data-edit="email" type="email" value="' + esc(u.email || '') + '">' +
                '<span data-view="email">' + esc(u.email || '') + '</span>' +
                '</td>' +
                '<td>' +
                '<select class="form-select form-select-sm d-none" data-edit="departmentID">' + deptOpts + '</select>' +
                '<span data-view="departmentID">' + esc(deptName(u.departmentID)) + '</span>' +
                '</td>' +
                '<td><span data-view="createdAt">' + esc(fmtDate(u.createdAt)) + '</span></td>' +
                '<td class="text-end row-actions">' +
                '<button class="btn btn-ghost btn-sm" data-act="edit" title="Edit"><i class="bi bi-pencil-square"></i></button>' +
                '<button class="btn btn-ghost btn-sm d-none" data-act="save" title="Save"><i class="bi bi-check2"></i></button>' +
                '<button class="btn btn-ghost btn-sm d-none" data-act="cancel" title="Cancel"><i class="bi bi-x"></i></button>' +
                '<button class="btn btn-ghost btn-sm text-danger" data-act="del" title="Delete"><i class="bi bi-trash"></i></button>' +
                '</td>';

            tr.querySelector('[data-act="edit"]').addEventListener('click', function () { enterEdit(tr); });
            tr.querySelector('[data-act="cancel"]').addEventListener('click', function () { exitEdit(tr, u); });
            tr.querySelector('[data-act="save"]').addEventListener('click', function () { saveRow(tr); });
            tr.querySelector('[data-act="del"]').addEventListener('click', function () { delUser(tr.dataset.id, u.fullName || u.email || 'this user'); });
            return tr;
        }

        function toggleRow(tr, editing) {
            var views = tr.querySelectorAll('[data-view]');
            var edits = tr.querySelectorAll('[data-edit]');
            for (var i = 0; i < views.length; i++) { views[i].classList.toggle('d-none', editing); }
            for (var j = 0; j < edits.length; j++) {
                edits[j].classList.toggle('d-none', !editing);
                edits[j].classList.toggle('editable', editing);
            }
            tr.querySelector('[data-act="edit"]').classList.toggle('d-none', editing);
            tr.querySelector('[data-act="save"]').classList.toggle('d-none', !editing);
            tr.querySelector('[data-act="cancel"]').classList.toggle('d-none', !editing);
        }
        function enterEdit(tr) { toggleRow(tr, true); }
        function exitEdit(tr, u) {
            tr.querySelector('[data-edit="fullName"]').value = u.fullName || '';
            tr.querySelector('[data-edit="email"]').value = u.email || '';
            tr.querySelector('[data-edit="departmentID"]').value = String(u.departmentID || '');
            toggleRow(tr, false);
        }

        async function saveRow(tr) {
            const id = tr.dataset.id;
            const payload = {
                userID: Number(id),
                fullName: tr.querySelector('[data-edit="fullName"]').value.trim(),
                email: tr.querySelector('[data-edit="email"]').value.trim(),
                departmentID: Number(tr.querySelector('[data-edit="departmentID"]').value)
            };
            try {
                const res = await fetch('/api/Users/' + encodeURIComponent(id), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) { alert('Update failed.'); return; }
                // update UI
                tr.querySelector('[data-view="fullName"]').textContent = payload.fullName;
                tr.querySelector('[data-view="email"]').textContent = payload.email;
                tr.querySelector('[data-view="departmentID"]').textContent = deptName(payload.departmentID);
                toggleRow(tr, false);
            } catch {
                alert('Update error.');
            }
        }

        async function delUser(id, label) {
            if (!confirm('Delete ' + label + '?')) return;
            try {
                const res = await fetch('/api/Users/' + encodeURIComponent(id), {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) { await refreshUsers(); }
                else {
                    const t = await res.text();
                    alert('Delete failed' + (t ? ': ' + t : ''));
                }
            } catch {
                alert('Delete error.');
            }
        }

        // Inline add
        function addInlineRow() {
            const tr = document.createElement('tr');
            // options for new row
            var opts = '';
            for (var k = 0; k < DEPARTMENTS.length; k++) {
                var d = DEPARTMENTS[k];
                opts += '<option value="' + d.id + '">' + esc(d.name) + '</option>';
            }
            tr.innerHTML =
                '<td><input class="form-control form-control-sm" placeholder="Full name"></td>' +
                '<td><input type="email" class="form-control form-control-sm" placeholder="Email"></td>' +
                '<td><select class="form-select form-select-sm">' + opts + '</select></td>' +
                '<td><span class="text-muted">—</span></td>' +
                '<td class="text-end">' +
                '<button class="btn btn-ghost btn-sm" data-act="saveNew" title="Save"><i class="bi bi-check2"></i></button>' +
                '<button class="btn btn-ghost btn-sm" data-act="cancelNew" title="Cancel"><i class="bi bi-x"></i></button>' +
                '</td>';
            tbody.prepend(tr);
            tr.querySelector('[data-act="cancelNew"]').addEventListener('click', function () { tr.remove(); });
            tr.querySelector('[data-act="saveNew"]').add
