<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OPC E‑Filing — Registry Logging</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        :root { --les-blue:#0c4ad4; --les-green:#1f8a43; --ink-700:#1f2a44; --nude-10:#fdfcfb; --nude-25:#fbf8f5; }
        body { font-family: Inter, sans-serif; color: var(--ink-700); background: radial-gradient(1200px 800px at 10% -10%, var(--nude-10), var(--nude-25)); padding-top: 72px; }
        .flag-bar { position:fixed; top:0; left:0; right:0; z-index:1040; }
        .flag-bar .bar{height:6px;}
        .flag-blue{background:var(--les-blue);} .flag-white{background:#fff;} .flag-green{background:var(--les-green);}    
        .navbar.glassy{background:rgba(255,255,255,.65)!important; backdrop-filter:blur(10px); border-bottom:1px solid rgba(0,0,0,.06);}    
        .brand-mark{display:flex; align-items:center; gap:.6rem; font-weight:800; color:#0b1020;}    
        .brand-mark img{width:32px; height:32px;}    
    </style>
</head>
<body>
    <div class="flag-bar">
        <div class="bar flag-blue"></div>
        <div class="bar flag-white"></div>
        <div class="bar flag-green"></div>
    </div>
    <!-- Global navigation with role-based visibility -->
    <nav class="navbar navbar-expand-lg glassy fixed-top">
        <div class="container">
            <a class="navbar-brand brand-mark" href="index.html">
                <img src="https://www.gov.ls/wp-content/uploads/2017/08/cropped-cropped-1162px-Coat_of_arms_of_Lesotho.svg_-1.png" alt="Lesotho Coat of Arms" />
                <span>OPC <span class="text-primary">E‑Filing</span></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="nav">
                <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
                    <li class="nav-item" data-roles="All"><a class="nav-link" href="dashboard.html"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter"><a class="nav-link" href="tasks.html"><i class="bi bi-list-check me-1"></i>My Tasks</a></li>
                    <li class="nav-item" data-roles="MDA"><a class="nav-link" href="submit-instruction.html"><i class="bi bi-plus-circle me-1"></i>New Instruction</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link" href="instructions.html"><i class="bi bi-card-list me-1"></i>Instructions</a></li>
                    <li class="nav-item" data-roles="PC"><a class="nav-link" href="pc-allocation.html"><i class="bi bi-person-plus me-1"></i>PC Allocation</a></li>
                    <li class="nav-item" data-roles="RegistryOfficer"><a class="nav-link active" aria-current="page" href="registry-logging.html"><i class="bi bi-archive me-1"></i>Registry Logging</a></li>
                    <li class="nav-item" data-roles="PC"><a class="nav-link" href="circulation.html"><i class="bi bi-send me-1"></i>Circulation</a></li>
                    <li class="nav-item" data-roles="PC,Admin"><a class="nav-link" href="templates.html"><i class="bi bi-layout-text-window me-1"></i>Templates</a></li>
                    <li class="nav-item" data-roles="PC,RegistryOfficer,Drafter,Admin"><a class="nav-link" href="search.html"><i class="bi bi-search me-1"></i>Search</a></li>
                    <li class="nav-item" data-roles="Admin"><a class="nav-link" href="manage-users.html"><i class="bi bi-people me-1"></i>User Management</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" id="logoutLink"><i class="bi bi-box-arrow-right me-1"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Dynamic navigation script: hide menu items based on roles and attach logout confirmation -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');
            let roles = [];
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1] || '')) || {};
                    const keys = ['role','roles','http://schemas.microsoft.com/ws/2008/06/identity/claims/role'];
                    keys.forEach(k => {
                        const v = payload[k];
                        if (Array.isArray(v)) roles = roles.concat(v);
                        else if (typeof v === 'string') roles.push(v);
                    });
                } catch {}
            }
            roles = roles.map(r => String(r));
            document.querySelectorAll('[data-roles]').forEach(el => {
                const allowed = el.getAttribute('data-roles').split(',').map(s => s.trim());
                if (!allowed.includes('All') && !allowed.some(r => roles.includes(r))) {
                    el.style.display = 'none';
                }
            });
            const current = location.pathname.split('/').pop();
            document.querySelectorAll('nav .nav-link[href]').forEach(link => {
                if (link.getAttribute('href') === current) {
                    link.classList.add('active');
                    link.setAttribute('aria-current','page');
                }
            });
            const logoutLink = document.getElementById('logoutLink');
            if (logoutLink) {
                logoutLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (confirm('Are you sure you want to log out?')) {
                        localStorage.removeItem('jwtToken');
                        window.location.href = 'login.html';
                    }
                });
            }
        });
    </script>
    <div class="container py-4">
        <h2 class="fw-bold mb-3">Registry Logging</h2>
        <p class="text-muted mb-4">Mark submitted instructions as logged.</p>
        <div class="table-responsive">
            <table class="table table-hover" id="regTable">
                <thead><tr><th>Title</th><th>Status</th><th>Priority</th><th>Received</th><th>Action</th></tr></thead>
                <tbody id="regBody"><tr><td colspan="5" class="text-center text-muted">Loading...</td></tr></tbody>
            </table>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('jwtToken');
            if (!token) { window.location.href = 'login.html'; return; }
            function fetchSubmitted() {
                return fetch('/api/RegistryLogging/Unlogged', { headers: { Authorization: 'Bearer ' + token } })
                    .then(res => res.ok ? res.json() : Promise.reject(res))
                    .then(render);
            }
            function render(instructions) {
                const body = document.getElementById('regBody');
                body.innerHTML = '';
                if (!instructions || instructions.length === 0) {
                    body.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No submitted instructions.</td></tr>';
                    return;
                }
                instructions.forEach(instr => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${instr.title || ''}</td><td>${instr.status}</td><td>${instr.priority || ''}</td><td>${new Date(instr.receivedDate).toLocaleDateString()}</td><td></td>`;
                    const actionCell = tr.lastElementChild;
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-primary';
                    btn.textContent = 'Mark Logged';
                    btn.addEventListener('click', () => markLogged(instr.draftingInstructionID));
                    actionCell.appendChild(btn);
                    body.appendChild(tr);
                });
            }
            function markLogged(id) {
                if (!confirm('Mark this instruction as logged?')) return;
                fetch(`/api/RegistryLogging/MarkLogged/${id}`, { method:'PUT', headers:{ Authorization:'Bearer ' + token } })
                    .then(res => res.ok ? res.json() : Promise.reject(res))
                    .then(() => { alert('Instruction marked as logged.'); fetchSubmitted(); })
                    .catch(() => alert('Failed to mark logged'));
            }
            fetchSubmitted();
        });
    </script>
</body>
</html>